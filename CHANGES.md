# 项目修改说明

## 修改概览

本次修改主要实现了以下功能：

1. ✅ 根据地图可视区域范围动态查询公园数据
2. ✅ 将COS图片URL转换为临时访问链接
3. ✅ 修正首页和详情页的字段展示
4. ✅ 创建云函数处理图片URL转换

---

## 详细修改内容

### 1. 云函数：getCosUrl

**位置**: `cloudfunctions/getCosUrl/`

**功能**: 生成腾讯云COS临时访问URL

**文件**:
- `index.js` - 云函数主逻辑
- `package.json` - 依赖配置（需要 `cos-nodejs-sdk-v5`）
- `config.json` - 云函数配置
- `README.md` - 使用说明

**部署步骤**:
1. 在微信开发者工具中右键点击 `cloudfunctions/getCosUrl` 文件夹
2. 选择"上传并部署：云端安装依赖（不上传node_modules）"
3. 等待部署完成

---

### 2. 首页修改 (index.js)

#### 2.1 新增数据字段
```javascript
data: {
  // ... 原有字段
  currentRegion: null  // 当前地图可视区域
}
```

#### 2.2 新增/修改方法

**`calculateLatLngRange(scale)`**
- 根据地图缩放级别计算经纬度查询范围
- scale越大，查询范围越小

**`loadParkData(region)`** - 已修改
- 支持根据地图区域范围查询
- 使用数据库范围查询（latitude、longitude字段）
- 查询集合：`park_20260119`

**`processParkData(parkList)`** - 已修改
- 批量调用云函数获取封面图临时URL
- 将图片URL映射为临时访问链接
- 正确解析tags字段（从逗号分隔的字符串转为数组）
- 标记点包含更多信息：coverImg, address, type, tags

**`onRegionChange(e)`** - 新增
- 监听地图区域变化事件
- 在拖动或缩放结束后自动重新加载数据
- 获取地图中心点和缩放级别

**`onMarkerTap(e)`** - 已修改
- 使用正确的数据库集合名称：`park_20260119`
- 调用云函数获取封面图临时URL
- 显示更多字段：type, phone, openTime, hectare

#### 2.3 WXML修改

**`index.wxml`**
- 地图组件添加 `bindregionchange="onRegionChange"` 事件绑定

---

### 3. 详情页修改 (detail.js)

#### 3.1 数据结构调整
```javascript
data: {
  placeInfo: null,      // 从null开始，动态加载
  images: [],           // 动态加载图片
  loading: true         // 加载状态
}
```

#### 3.2 新增/修改方法

**`loadParkDetail(parkId)`** - 新增
- 从数据库 `park_20260119` 加载公园详情
- 调用云函数批量获取图片临时URL（封面图+详情图）
- 自动解析tags并生成图标
- 根据数据自动生成描述文本
- 智能推断设施信息

**`getTagIcon(tag)`** - 新增
- 根据标签内容返回对应的emoji图标
- 支持模糊匹配

**`generateDescription(park)`** - 新增
- 根据公园数据自动生成描述文本
- 包含：类型、面积、管理单位、特色、开放时间

**`parseFacilities(park)`** - 新增
- 根据标签智能推断设施信息
- 返回设施图标和名称数组

**`onLoad(options)`** - 已修改
- 调用 `loadParkDetail` 加载数据

**其他方法** - 已修改
- 增加空值检查，防止数据未加载时报错
- 使用真实的经纬度数据

---

## 数据库字段映射

根据您提供的示例数据，字段映射如下：

| 数据库字段 | 说明 | 使用位置 |
|-----------|------|---------|
| `name` | 公园名称 | 首页标题、详情页标题 |
| `latitude` | 纬度 | 地图标记点、范围查询 |
| `longitude` | 经度 | 地图标记点、范围查询 |
| `address` | 地址 | 底部卡片、详情页 |
| `type` | 类型（如"城市公园"） | 底部卡片、详情页 |
| `coverImg` | 封面图URL | 底部卡片、详情页轮播 |
| `imgs` | 详情图URL数组 | 详情页轮播 |
| `tags` | 标签（逗号分隔） | 底部卡片、详情页 |
| `phone` | 联系电话 | 详情页 |
| `openTime` | 开放时间 | 详情页 |
| `isOpen` | 是否开放（"1"开放） | 详情页状态 |
| `hectare` | 面积（公顷） | 详情页描述 |
| `managementunit` | 管理单位 | 详情页描述 |
| `department` | 主管部门 | 详情页 |
| `url` | 官方链接 | 详情页（可扩展） |

---

## 图片URL处理流程

### 原始URL格式
```
https://parks-1391406291.cos.ap-guangzhou.myqcloud.com/images/10775328/10775328_0.jpg
```

### 处理流程
1. 小程序调用云函数 `getCosUrl`
2. 云函数使用COS SDK生成签名URL
3. 返回临时访问URL（有效期可配置，默认1小时）
4. 小程序使用临时URL显示图片

### 安全性
- COS密钥（SecretId、SecretKey）存储在云函数中
- 不暴露在小程序前端代码中
- 临时URL有时效性

---

## 测试步骤

### 1. 部署云函数
```bash
# 在微信开发者工具中
右键 cloudfunctions/getCosUrl → 上传并部署：云端安装依赖
```

### 2. 测试首页
1. 打开首页，应自动加载公园数据
2. 拖动地图，观察数据是否刷新
3. 缩放地图，观察查询范围变化
4. 点击标记点，查看底部卡片显示

### 3. 测试详情页
1. 点击底部卡片进入详情页
2. 查看图片是否正常显示
3. 查看各字段是否正确展示
4. 测试导航、拨打电话等功能

---

## 注意事项

1. **云函数必须先部署**，否则图片无法显示
2. **数据库集合名称**：确认使用 `park_20260119`
3. **COS密钥**：已硬编码在云函数中，生产环境建议使用环境变量
4. **临时URL有效期**：默认2小时（7200秒），可根据需要调整
5. **地图范围查询**：首次加载不限制范围，移动地图后按范围查询
6. **数据库查询限制**：单次最多返回100条，如需更多请使用分页

---

## 后续优化建议

1. 添加数据缓存，减少云函数调用
2. 实现分类筛选功能
3. 添加搜索功能
4. 优化图片加载性能（懒加载）
5. 添加收藏功能
6. 实现用户评价功能
7. 将COS密钥移到云函数环境变量中

---

## 问题排查

### 图片不显示
1. 检查云函数是否已部署
2. 查看控制台是否有错误信息
3. 确认COS密钥是否正确
4. 确认图片URL格式是否正确

### 数据不显示
1. 检查数据库集合名称是否为 `park_20260119`
2. 查看控制台数据查询日志
3. 确认数据库权限配置

### 地图不刷新
1. 检查 `bindregionchange` 事件是否绑定
2. 查看 `onRegionChange` 方法是否执行
3. 确认 `mapCtx.getRegion` 是否返回数据
